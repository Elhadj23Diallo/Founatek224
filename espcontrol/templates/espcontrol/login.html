{% extends "espcontrol/base.html" %}

{% block content %}

<center><h2>Bienvenu sur notre l'application IoT</h2></center>

<!-- Formulaire de connexion avec classes pour styliser -->
<form id="login-form" class="login-form">
    <label for="username">Nom d'utilisateur :</label>
    <input type="text" id="username" name="username" required class="input-field"><br><br>

    <label for="password">Mot de passe :</label>
    <input type="password" id="password" name="password" required class="input-field"><br><br>

    <button type="submit" class="submit-btn">Se connecter</button>
</form>

<p id="status" class="status-message"></p>

<script>
    const form = document.getElementById('login-form');
    const status = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/token/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('access_token', data.access);
                localStorage.setItem('refresh_token', data.refresh);
                status.style.color = 'green';
                status.innerText = 'Connexion réussie ✅';

                // ✅ Redirection vers la page d'accueil après 1 seconde
                setTimeout(() => {
                    window.location.href = "/home/";
                }, 1000);
            } else {
                status.innerText = "Nom d'utilisateur ou mot de passe incorrect.";
                status.style.color = 'red';
            }
        } catch (error) {
            status.innerText = "Erreur lors de la connexion.";
            status.style.color = 'red';
            console.error(error);
        }
    });
</script>

{% endblock %}
